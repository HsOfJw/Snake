{"version":3,"sources":["..\\..\\..\\..\\assets\\scripts/assets\\scripts\\RankListScene.js"],"names":["cc","Class","extends","Component","properties","rankingScrollView","ScrollView","scrollViewContent","Node","prefabRankItem","Prefab","myrank","show","fetchFriendData","clearCanvas","removeChild","node","removeChildByTag","removeAllChildren","active","self","wx","getUserInfo","openIdList","success","userRes","console","log","data","userData","getFriendCloudStorage","keyList","res","sortData","dataSort","i","length","playerInfo","item","instantiate","rankItem","getComponent","initView","addChild","y","selfData","getSelfData","userItem","fail","loadingLabel","Label","string","level_data","JSON","parse","KVDataList","value","passtime_data","level_num","total_pass_time","j","sort","a","b","alldata","avatarUrl"],"mappings":"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","file":"RankListScene.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["// var Util = require(\"Util\");\r\n// var GameConfig = require(\"ConstDefine\").GameConfig;\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        rankingScrollView: cc.ScrollView,\r\n        scrollViewContent: cc.Node,\r\n        prefabRankItem: cc.Prefab,\r\n    },\r\n\r\n    // onLoad () {},\r\n\r\n    myrank: null,\r\n\r\n    show () {\r\n        this.fetchFriendData();\r\n    },\r\n\r\n    clearCanvas(){\r\n        this.removeChild();\r\n    },\r\n\r\n    removeChild() {\r\n        this.node.removeChildByTag(1000);\r\n        this.scrollViewContent.removeAllChildren();\r\n        this.rankingScrollView.node.active = false;\r\n    },\r\n\r\n    fetchFriendData(){\r\n        var self = this;\r\n        \r\n        this.rankingScrollView.node.active = true;\r\n\r\n        wx.getUserInfo({\r\n            openIdList: ['selfOpenId'],\r\n            success: (userRes) => {\r\n                console.log('success', userRes.data)\r\n                let userData = userRes.data[0];\r\n                //取出所有好友数据\r\n                wx.getFriendCloudStorage({\r\n                    keyList: ['level_num', 'pass_time'],\r\n                    success: res => {\r\n                        console.log(\"wx.getFriendCloudStorage success\", res);\r\n                        let data = res.data;\r\n\r\n                        var sortData = self.dataSort(data);\r\n\r\n                        for (var i = 0; i < data.length; i++) {\r\n                            if(i >= 10){\r\n                                break;\r\n                            }\r\n                            var playerInfo = data[i];\r\n                            var item = cc.instantiate(self.prefabRankItem);\r\n                            var rankItem = item.getComponent('RankItem');\r\n                            if(rankItem){\r\n                                rankItem.initView(i + 1, playerInfo);\r\n                            }\r\n                            self.scrollViewContent.addChild(item);\r\n                            item.y = -(i * 140);\r\n                        }\r\n\r\n                        var selfData = self.getSelfData(data, userData);\r\n                        if(selfData){\r\n                            let userItem = cc.instantiate(self.prefabRankItem);\r\n                            userItem.getComponent('RankItem').initView(self.myrank, selfData, true);\r\n                            userItem.y = -200;\r\n                            self.node.addChild(userItem, 1, 1000);\r\n                        }\r\n\r\n                        // if (data.length <= 8) {\r\n                        //     let layout = self.scrollViewContent.getComponent(cc.Layout);\r\n                        //     layout.resizeMode = cc.Layout.ResizeMode.NONE;\r\n                        // }\r\n                    },\r\n                    fail: res => {\r\n                        console.log(\"wx.getFriendCloudStorage fail\", res);\r\n                        self.loadingLabel.getComponent(cc.Label).string = \"数据加载失败，请检测网络，谢谢。\";\r\n                    },\r\n                });\r\n            },\r\n            fail: (res) => {\r\n                self.loadingLabel.getComponent(cc.Label).string = \"数据加载失败，请检测网络，谢谢。\";\r\n            }\r\n        });\r\n    },\r\n\r\n    dataSort(data){\r\n        for(var i = 0;i < data.length;i ++){\r\n            var item = data[i];\r\n\r\n            var level_data = JSON.parse(item.KVDataList[0].value);\r\n            var passtime_data = JSON.parse(item.KVDataList[1].value);\r\n\r\n            item.level_num = level_data.length;\r\n\r\n            item.total_pass_time = 0;\r\n            for(var j = 0;j < passtime_data.length;j ++){\r\n                item.total_pass_time += passtime_data[j];\r\n            }\r\n        }\r\n\r\n        data.sort((a, b) => {\r\n            if (a.KVDataList.length == 0 && b.KVDataList.length == 0) {\r\n                return 0;\r\n            }\r\n            if (a.KVDataList.length == 0) {\r\n                return 1;\r\n            }\r\n            if (b.KVDataList.length == 0) {\r\n                return -1;\r\n            }\r\n\r\n            if(b.level_num != a.level_num){\r\n                return b.level_num - a.level_num;\r\n            }else{\r\n                return a.total_pass_time - b.total_pass_time;\r\n            }\r\n        });\r\n    },\r\n\r\n    getSelfData(alldata, userData){\r\n        for(var i = 0; i < alldata.length; i++){ \r\n            if(alldata[i].avatarUrl == userData.avatarUrl){\r\n                this.myrank = i + 1;\r\n                return alldata[i];\r\n            }\r\n        }\r\n        return null;\r\n    },\r\n\r\n    // update (dt) {},\r\n});\r\n"]}